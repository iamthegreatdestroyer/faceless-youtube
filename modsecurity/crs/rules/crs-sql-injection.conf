# OWASP Core Rule Set v4.0 - CRS SQL Injection Rules
# Rules for detecting SQL Injection attacks
# Rule Range: 1001-1100

###############################################################################
# SQL Injection Detection Rules (CRS-1001-1030)
###############################################################################

# SQL Injection - Basic UNION SELECT detection
SecRule ARGS|HEADERS "@rx (?:union|select|insert|update|delete)\s+(?:all\s+)?select" \
    "id:1001,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection Attack Detected - UNION SELECT',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    tag:'crs-v4.0.0-http-attack',\
    severity:CRITICAL,\
    capture,\
    setvar:tx.sql_injection_score=+4,\
    setvar:ip.sql_injection_attempts=+1"

# SQL Injection - Comment sequences
SecRule ARGS|HEADERS "@rx (--|;|/\*|#)" \
    "id:1002,\
    phase:2,\
    log,block,\
    msg:'SQL Injection Attempt - Comment Sequence Detected',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.sql_injection_score=+3"

# SQL Injection - OR condition bypass
SecRule ARGS|HEADERS "@rx '\s+or\s+'1'\s*=\s*'1" \
    "id:1003,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - OR 1=1 Bypass Detected',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+5,\
    setvar:ip.sql_injection_attempts=+2"

# SQL Injection - EXEC/EXECUTE detection
SecRule ARGS|HEADERS "@rx \b(exec|execute|sp_executesql|xp_cmdshell)\s*\(" \
    "id:1004,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - Command Execution Attempt',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+5"

# SQL Injection - Stacked queries detection (semicolon followed by command)
SecRule ARGS|HEADERS "@rx ;\s*(DROP|CREATE|ALTER|DELETE|UPDATE)\s+" \
    "id:1005,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - Stacked Query Attempt',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+4"

# SQL Injection - HAVING clause injection
SecRule ARGS|HEADERS "@rx \bHAVING\b" \
    "id:1006,\
    phase:2,\
    log,block,\
    msg:'SQL Injection - HAVING Clause Injection',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.sql_injection_score=+2"

# SQL Injection - GROUP BY injection
SecRule ARGS|HEADERS "@rx \bGROUP\s+BY\b" \
    "id:1007,\
    phase:2,\
    log,block,\
    msg:'SQL Injection - GROUP BY Injection',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.sql_injection_score=+2"

# SQL Injection - CASE/WHEN detection
SecRule ARGS|HEADERS "@rx \b(CASE|WHEN|THEN|ELSE|END)\b" \
    "id:1008,\
    phase:2,\
    log,block,\
    msg:'SQL Injection - CASE Statement Injection',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.sql_injection_score=+1"

# SQL Injection - Boolean-based blind SQL injection
SecRule ARGS|HEADERS "@rx (AND\s+1\s*=\s*1|AND\s+1\s*=\s*2)" \
    "id:1009,\
    phase:2,\
    log,block,\
    msg:'SQL Injection - Boolean-Based Blind SQL Injection',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.sql_injection_score=+3"

# SQL Injection - Time-based blind SQL injection
SecRule ARGS|HEADERS "@rx (SLEEP|BENCHMARK|WAITFOR|DELAY)\s*\(" \
    "id:1010,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - Time-Based Blind SQL Injection',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+4"

###############################################################################
# SQL Injection - Character Encoding Bypass
###############################################################################

# SQL Injection - Hex encoding bypass
SecRule ARGS|HEADERS "@rx 0x[0-9a-f]{2,}" \
    "id:1011,\
    phase:2,\
    log,block,\
    msg:'SQL Injection - Hex Encoding Bypass Attempt',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.sql_injection_score=+2"

# SQL Injection - URL encoding bypass detection
SecRule ARGS|HEADERS "@rx %27|%22|%3B|%2D%2D" \
    "id:1012,\
    phase:2,\
    log,block,\
    msg:'SQL Injection - URL Encoded SQL Syntax Detected',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.sql_injection_score=+1"

###############################################################################
# SQL Injection - Database-Specific Attacks
###############################################################################

# MySQL-specific SQL injection
SecRule ARGS|HEADERS "@rx \b(INFORMATION_SCHEMA|mysql\.user|@@version|INTO\s+OUTFILE|LOAD_FILE)\b" \
    "id:1013,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - MySQL-Specific Attack',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+4"

# PostgreSQL-specific SQL injection
SecRule ARGS|HEADERS "@rx \b(pg_sleep|pg_version|information_schema|pg_catalog)\b" \
    "id:1014,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - PostgreSQL-Specific Attack',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+4"

# MSSQL-specific SQL injection
SecRule ARGS|HEADERS "@rx \b(xp_cmdshell|sp_executesql|CAST|CONVERT)\s*\(" \
    "id:1015,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - MSSQL-Specific Attack',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+4"

# Oracle-specific SQL injection
SecRule ARGS|HEADERS "@rx \b(UTL_HTTP|UTL_FILE|DBMS_SQL|dbms_lock|dbms_pipe)\b" \
    "id:1016,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection - Oracle-Specific Attack',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.sql_injection_score=+4"

###############################################################################
# SQL Injection - Anomaly Scoring
###############################################################################

# Trigger blocking if SQL injection score exceeds threshold
SecRule TX.sql_injection_score "@ge %{tx.sql_injection_anomaly_score}" \
    "id:1050,\
    phase:2,\
    log,auditlog,block,\
    msg:'SQL Injection Attack Blocked - Cumulative Score Exceeded',\
    tag:'attack/sql-injection',\
    tag:'OWASP_CRS',\
    tag:'anomaly-evaluation',\
    severity:CRITICAL"

# Reset SQL injection score for next request
SecAction "id:1099,\
    phase:5,\
    nolog,pass,\
    setvar:tx.sql_injection_score=0"

###############################################################################
# End of SQL Injection Rules
###############################################################################
