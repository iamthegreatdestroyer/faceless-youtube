# OWASP Core Rule Set v4.0 - Command Injection & Path Traversal Rules
# Rules for detecting command injection and directory traversal attacks
# Rule Range: 3001-3200

###############################################################################
# Command Injection Detection (CRS-3001-3050)
###############################################################################

# Command Injection - Shell metacharacters
SecRule ARGS|HEADERS "@rx [;&|`$\(\){}[\]]" \
    "id:3001,\
    phase:2,\
    log,block,\
    msg:'Command Injection - Shell Metacharacters Detected',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.command_injection_score=+2"

# Command Injection - Pipe character for command chaining
SecRule ARGS|HEADERS "@rx \|\s*(cat|ls|whoami|id|pwd|nc|ncat|curl|wget)" \
    "id:3002,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection - Command Chaining Detected',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    capture,\
    setvar:tx.command_injection_score=+4,\
    setvar:ip.command_injection_attempts=+1"

# Command Injection - Semicolon command separation
SecRule ARGS|HEADERS "@rx ;\s*(cat|ls|whoami|id|pwd|wget|curl|nc|bash|sh|cmd|powershell)" \
    "id:3003,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection - Semicolon Command Separation',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.command_injection_score=+4"

# Command Injection - Backtick command substitution
SecRule ARGS|HEADERS "@rx `[^`]*`" \
    "id:3004,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection - Backtick Command Substitution',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.command_injection_score=+4"

# Command Injection - $() command substitution
SecRule ARGS|HEADERS "@rx \$\([^)]*\)" \
    "id:3005,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection - Dollar Parenthesis Command Substitution',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.command_injection_score=+4"

# Command Injection - AND operator (&&) command chaining
SecRule ARGS|HEADERS "@rx &&\s*(cat|ls|whoami|id|pwd|wget|curl|nc|bash|sh)" \
    "id:3006,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection - AND Operator Command Chaining',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.command_injection_score=+4"

# Command Injection - OR operator (||) command chaining
SecRule ARGS|HEADERS "@rx \|\|\s*(cat|ls|whoami|id|pwd|wget|curl|bash|sh)" \
    "id:3007,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection - OR Operator Command Chaining',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.command_injection_score=+4"

# Command Injection - Reverse shell attempts (nc, bash, etc.)
SecRule ARGS|HEADERS "@rx (bash|sh|nc|ncat|powershell)\s+-[i|e|c]|bash\s*-i.*>/dev/tcp" \
    "id:3008,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection - Reverse Shell Attempt',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.command_injection_score=+5,\
    setvar:ip.command_injection_attempts=+2"

# Command Injection - New line character for command injection
SecRule ARGS|HEADERS "@rx %0a|%0d|\\n|\\r" \
    "id:3009,\
    phase:2,\
    log,block,\
    msg:'Command Injection - Newline Character Detected',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.command_injection_score=+1"

# Command Injection - Null byte injection
SecRule ARGS|HEADERS "@rx %00|\\x00" \
    "id:3010,\
    phase:2,\
    log,block,\
    msg:'Command Injection - Null Byte Injection',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.command_injection_score=+1"

###############################################################################
# Path Traversal Detection (CRS-3051-3150)
###############################################################################

# Path Traversal - Basic ../ pattern
SecRule ARGS|HEADERS "@rx \.\./|\.\.%2f|\.\.%5c" \
    "id:3051,\
    phase:2,\
    log,auditlog,block,\
    msg:'Path Traversal Attack Detected - Directory Traversal',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    tag:'crs-v4.0.0-http-attack',\
    severity:HIGH,\
    capture,\
    setvar:tx.path_traversal_score=+3,\
    setvar:ip.path_traversal_attempts=+1"

# Path Traversal - Windows backslash traversal
SecRule ARGS|HEADERS "@rx \.\.\\|%2e%2e%5c" \
    "id:3052,\
    phase:2,\
    log,auditlog,block,\
    msg:'Path Traversal - Windows Backslash Traversal',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.path_traversal_score=+3"

# Path Traversal - Encoded dot sequences
SecRule ARGS|HEADERS "@rx %2e%2e|%252e%252e|\.%252e|%25252e" \
    "id:3053,\
    phase:2,\
    log,block,\
    msg:'Path Traversal - Encoded Dot Sequences',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.path_traversal_score=+1"

# Path Traversal - Access to sensitive directories
SecRule ARGS|HEADERS "@rx /etc/|/proc/|/sys/|C:\\Windows|C:\\Program Files" \
    "id:3054,\
    phase:2,\
    log,auditlog,block,\
    msg:'Path Traversal - Sensitive Directory Access Attempt',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.path_traversal_score=+4"

# Path Traversal - Access to sensitive files
SecRule ARGS|HEADERS "@rx /etc/(passwd|shadow|hosts|ssl)|/root/|/home/.*/.ssh" \
    "id:3055,\
    phase:2,\
    log,auditlog,block,\
    msg:'Path Traversal - Sensitive File Access Attempt',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.path_traversal_score=+4"

# Path Traversal - Null byte file extension bypass
SecRule ARGS|HEADERS "@rx %00\.(html|txt|jsp|php|asp)" \
    "id:3056,\
    phase:2,\
    log,auditlog,block,\
    msg:'Path Traversal - Null Byte File Extension Bypass',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.path_traversal_score=+3"

# Path Traversal - Unicode/UTF-8 encoding bypass
SecRule ARGS|HEADERS "@rx %c0%ae|..%252f|%e0%80%ae" \
    "id:3057,\
    phase:2,\
    log,block,\
    msg:'Path Traversal - Unicode Encoding Bypass',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.path_traversal_score=+1"

# Path Traversal - Absolute path specification
SecRule ARGS|HEADERS "@rx ^/etc|^/var|^/proc|^/sys|^C:" \
    "id:3058,\
    phase:2,\
    log,block,\
    msg:'Path Traversal - Absolute Path Specification',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.path_traversal_score=+2"

# Path Traversal - Multiple encoding attempts
SecRule ARGS|HEADERS "@rx %25%32%65|%25%35%32|%26%35%32" \
    "id:3059,\
    phase:2,\
    log,block,\
    msg:'Path Traversal - Double/Triple Encoding',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.path_traversal_score=+1"

###############################################################################
# Remote File Inclusion Detection (CRS-3151-3200)
###############################################################################

# RFI - HTTP/HTTPS protocol in parameter
SecRule ARGS|HEADERS "@rx (http|https|ftp)://[^/]*(/|\\\\)" \
    "id:3151,\
    phase:2,\
    log,auditlog,block,\
    msg:'Remote File Inclusion - External URL Detected',\
    tag:'attack/rfi',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.rfi_score=+3"

# RFI - PHP stream wrappers
SecRule ARGS|HEADERS "@rx php://|file://|gopher://|data://|expect://" \
    "id:3152,\
    phase:2,\
    log,auditlog,block,\
    msg:'Remote File Inclusion - PHP Stream Wrapper',\
    tag:'attack/rfi',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.rfi_score=+4"

# RFI - Suspicious extension bypass
SecRule ARGS|HEADERS "@rx \.(php|asp|jsp|cgi|pl)\?" \
    "id:3153,\
    phase:2,\
    log,block,\
    msg:'Remote File Inclusion - Extension Bypass Attempt',\
    tag:'attack/rfi',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.rfi_score=+2"

###############################################################################
# Anomaly Scoring
###############################################################################

# Block if command injection score exceeds threshold
SecRule TX.command_injection_score "@ge %{tx.command_injection_threshold}" \
    "id:3100,\
    phase:2,\
    log,auditlog,block,\
    msg:'Command Injection Attack Blocked',\
    tag:'attack/command-injection',\
    tag:'OWASP_CRS',\
    tag:'anomaly-evaluation',\
    severity:CRITICAL"

# Block if path traversal score exceeds threshold
SecRule TX.path_traversal_score "@ge %{tx.path_traversal_threshold}" \
    "id:3151,\
    phase:2,\
    log,auditlog,block,\
    msg:'Path Traversal Attack Blocked',\
    tag:'attack/path-traversal',\
    tag:'OWASP_CRS',\
    tag:'anomaly-evaluation',\
    severity:CRITICAL"

# Block if RFI score exceeds threshold
SecRule TX.rfi_score "@ge 3" \
    "id:3200,\
    phase:2,\
    log,auditlog,block,\
    msg:'Remote File Inclusion Attack Blocked',\
    tag:'attack/rfi',\
    tag:'OWASP_CRS',\
    tag:'anomaly-evaluation',\
    severity:CRITICAL"

# Reset scores for next request
SecAction "id:3299,\
    phase:5,\
    nolog,pass,\
    setvar:tx.command_injection_score=0,\
    setvar:tx.path_traversal_score=0,\
    setvar:tx.rfi_score=0"

###############################################################################
# End of Command Injection, Path Traversal, and RFI Rules
###############################################################################
