# ModSecurity Web Application Firewall Configuration
# Generated for FacelessYouTube Staging Environment
# Provides protection against OWASP Top 10 and common web attacks
# Date: October 25, 2025

###############################################################################
# Core ModSecurity Configuration
###############################################################################

# Set ModSecurity to use all available rules (blocking mode)
# Possible values: On | Off | DetectionOnly
SecRuleEngine On

# Paranoia Level
# 1 = Default (catches most attacks, minimal false positives)
# 2 = More aggressive
# 3 = Very aggressive
# 4 = Extremely aggressive (use with caution, many false positives)
SecAction "id:1,phase:1,nolog,pass,setvar:tx.paranoia_level=1"

# Rule ID offset to avoid conflicts
SecAction "id:2,phase:1,nolog,pass,setvar:tx.rule_id_offset=10000"

###############################################################################
# Request and Response Body Handling
###############################################################################

# Store request and response bodies for analysis
SecRequestBodyAccess On
SecResponseBodyAccess On

# Request body limits (10MB max)
SecRequestBodyLimit 10485760
SecRequestBodyNoFilesLimit 1048576
SecRequestBodyLimitAction ProcessPartial
SecRequestBodyParser multipart
SecRequestBodyParser application/json

# Response body limits (512KB max)
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Temp storage location for request bodies
SecTmpDir /tmp/modsecurity/
SecDataDir /tmp/modsecurity/

###############################################################################
# Audit Logging Configuration
###############################################################################

# Enable audit logging (comprehensive forensics)
SecAuditEngine On
SecAuditLog /var/log/modsecurity/audit.log

# Audit logging modes:
# On      = Log everything
# Off     = No audit logging
# RelevantOnly = Log only relevant transactions
SecAuditLogRelevantStatus "^[45]"
SecAuditLogParts "ABCDEFGHIJK"

# Audit log format (JSON for better parsing)
SecAuditLogFormat JSON

# Audit log type (Serial for simplicity, Concurrent for parallel processing)
SecAuditLogType Serial

# Log additional information
SecAuditLogStorageDir /var/log/modsecurity/audit/

###############################################################################
# File Uploads and Antiviruses
###############################################################################

# Verify that uploaded files match declared MIME type
SecUploadDir /tmp/modsecurity/uploads/
SecUploadKeepFiles Off

# Limit file uploads to 100MB
SecUploadFileLimit 100

###############################################################################
# Anomaly Scoring Mode
###############################################################################

# Enable anomaly scoring for coordinated attack detection
# Individual rules can contribute to anomaly scores
SecAction "id:3,phase:1,nolog,pass,setvar:tx.anomaly_score=0"
SecAction "id:4,phase:1,nolog,pass,setvar:tx.anomaly_score_blocking=5"

# Inbound anomaly threshold
# Requests exceeding this threshold are blocked
SecAction "id:5,phase:5,nolog,pass,setvar:tx.inbound_anomaly_score_threshold=5"

# Outbound anomaly threshold
# Responses exceeding this threshold are logged
SecAction "id:6,phase:5,nolog,pass,setvar:tx.outbound_anomaly_score_threshold=4"

###############################################################################
# HTTP Policy Enforcement
###############################################################################

# Check HTTP method validity
SecAction "id:7,phase:1,nolog,pass,setvar:tx.allowed_methods=GET|HEAD|POST|PUT|DELETE|OPTIONS|PATCH|CONNECT|TRACE"

# Allowed file extensions (whitelist approach)
SecAction "id:8,phase:1,nolog,pass,setvar:tx.allowed_upload_extensions=.jpg|.jpeg|.png|.gif|.pdf|.doc|.docx|.xlsx|.csv"

# Restricted upload extensions (blacklist approach)
SecAction "id:9,phase:1,nolog,pass,setvar:tx.restricted_extensions=.exe|.bat|.cmd|.com|.sh|.bash|.php|.jsp|.asp"

###############################################################################
# Custom Thresholds and Configuration
###############################################################################

# SQL Injection detection threshold
SecAction "id:10,phase:1,nolog,pass,setvar:tx.sql_injection_score_threshold=4"

# XSS detection threshold
SecAction "id:11,phase:1,nolog,pass,setvar:tx.xss_score_threshold=3"

# Command Injection detection threshold
SecAction "id:12,phase:1,nolog,pass,setvar:tx.command_injection_threshold=2"

# Path Traversal detection threshold
SecAction "id:13,phase:1,nolog,pass,setvar:tx.path_traversal_threshold=2"

###############################################################################
# Logging and Error Handling
###############################################################################

# Log level: debug(9) | info(7) | notice(5) | warn(4) | crit(2) | alert(1) | emerg(0)
SecLogLevel 3

# Log file location
SecLog /var/log/modsecurity/modsec_debug.log

# Error action: block | pass | log | nolog | allow
# Default action for rule violations
SecDefaultAction "phase:2,log,auditlog,block"

###############################################################################
# Connection Handling
###############################################################################

# Keep-alive timeout
SecAction "id:14,phase:1,nolog,pass,setenv:TIMEOUT=300"

# Close connection if size limit reached
SecAction "id:15,phase:1,nolog,pass,setenv:CLOSE_CONNECTION_ON_BODY_LIMIT=1"

###############################################################################
# Performance Tuning
###############################################################################

# Disable buffering if not needed (improves latency)
# Keep enabled for request/response analysis
SecAction "id:16,phase:1,nolog,pass,setvar:tx.buffering_enabled=1"

# Cache regular expressions for performance
SecAction "id:17,phase:1,nolog,pass,setvar:tx.regex_cache_size=4096"

# Reduce rule processing time
SecAction "id:18,phase:1,nolog,pass,setvar:tx.max_rule_execution_time=200"

###############################################################################
# Exclusions and Exceptions
###############################################################################

# Exclude specific paths from WAF analysis
# These will bypass ModSecurity rules entirely
# Add health check endpoint
SecRule REQUEST_URI "@streq /health" "id:1000,phase:1,log,nolog,pass"

# Exclude Prometheus metrics endpoint
SecRule REQUEST_URI "@streq /metrics" "id:1001,phase:1,log,nolog,pass"

# Exclude API documentation endpoints
SecRule REQUEST_URI "@rx ^/api/v\d+/docs" "id:1002,phase:1,log,nolog,pass"

# Exclude Swagger UI
SecRule REQUEST_URI "@rx ^/swagger" "id:1003,phase:1,log,nolog,pass"

###############################################################################
# Custom Headers and Variables
###############################################################################

# Add security headers to response
SecAction "id:2000,phase:5,nolog,pass,setenv:HEADER_X_FRAME_OPTIONS=DENY"
SecAction "id:2001,phase:5,nolog,pass,setenv:HEADER_X_CONTENT_TYPE_OPTIONS=nosniff"
SecAction "id:2002,phase:5,nolog,pass,setenv:HEADER_X_XSS_PROTECTION=1;mode=block"

# Capture client IP (handle proxy headers)
SecRule &REMOTE_ADDR "@ge 1" "id:2100,phase:1,nolog,pass,\
    setvar:tx.client_ip=%{REMOTE_ADDR},\
    chain"
    SecRule HTTP_X_FORWARDED_FOR "@rx ^([0-9\.]+)" "setvar:tx.client_ip=%{TX.1}"

###############################################################################
# Action Logging
###############################################################################

# Log all transactions (for debugging)
SecRule ARGS "@rx ." "id:2200,phase:5,log,pass,noauditlog,msg:'Request processed'"

# Log all blocked transactions
SecRule &TX.block_flag "@ge 1" "id:2201,phase:5,log,auditlog,pass,msg:'Request blocked by WAF rule'"

###############################################################################
# Rule Loading
###############################################################################

# Include OWASP CRS configuration
Include /etc/modsecurity/crs/crs-setup.conf

# Include OWASP CRS rules
Include /etc/modsecurity/crs/rules/*.conf

# Include custom application rules
Include /etc/modsecurity/modsecurity-custom-rules.conf

###############################################################################
# End of ModSecurity Configuration
###############################################################################
