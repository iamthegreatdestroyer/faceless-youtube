# OWASP Core Rule Set (CRS) v4.0 - Setup Configuration
# Configures CRS behavior and rule groups
# Date: October 25, 2025

###############################################################################
# CRS Global Configuration
###############################################################################

# Paranoia Level: 1 (default) to 4 (aggressive)
# Level 1: Standard protection, minimal false positives
# Level 2: More aggressive, some false positives possible
# Level 3: Very aggressive, stricter rules
# Level 4: Maximum protection, high false positive rate
SecAction "id:900000,phase:1,nolog,pass,setvar:tx.paranoia_level=1"

# Executing Paranoia Level (only run rules matching this level)
SecAction "id:900001,phase:1,nolog,pass,setvar:tx.executing_paranoia_level=1"

# Max Paranoia Level (used for rule organization)
SecAction "id:900002,phase:1,nolog,pass,setvar:tx.max_paranoia_level=4"

###############################################################################
# HTTP Policy Enforcement
###############################################################################

# Allowed HTTP Methods (GET, POST, PUT, DELETE, HEAD, OPTIONS, PATCH)
SecAction "id:900010,phase:1,nolog,pass,setvar:tx.allowed_methods=GET|HEAD|POST|PUT|DELETE|OPTIONS|PATCH|CONNECT|TRACE"

# Allowed Content-Type values
SecAction "id:900011,phase:1,nolog,pass,setvar:tx.allowed_content_types=text/html|application/json|application/x-www-form-urlencoded|multipart/form-data|text/plain|application/xml|text/xml"

# Log HTTP methods not in whitelist
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods}" "id:900012,phase:2,log,block,msg:'HTTP method not allowed: %{REQUEST_METHOD}',tag:'Protocol Enforcement',tag:'CRS Policy Enforcement'"

###############################################################################
# IP Reputation
###############################################################################

# Track inbound anomaly score per IP
SecAction "id:900020,phase:1,nolog,pass,setvar:ip.anomaly_score=0"

# Track outbound anomaly score per IP
SecAction "id:900021,phase:1,nolog,pass,setvar:ip.is_scanning=0"

###############################################################################
# Argument and Cookie Limits
###############################################################################

# Maximum number of arguments allowed in request
SecAction "id:900030,phase:1,nolog,pass,setvar:tx.max_arguments=256"

# Maximum combined size of arguments (100KB)
SecAction "id:900031,phase:1,nolog,pass,setvar:tx.max_combined_argument_size=102400"

# Enforce argument limits
SecRule &ARGS "@gt %{tx.max_arguments}" "id:900032,phase:2,log,block,msg:'Too many arguments in request',tag:'Argument Limit Enforcement'"

###############################################################################
# SQL Injection Protection
###############################################################################

# Enable SQL Injection detection
SecAction "id:900100,phase:1,nolog,pass,setvar:tx.sql_injection_enabled=1"

# SQL Injection anomaly score threshold (per individual rule)
SecAction "id:900101,phase:1,nolog,pass,setvar:tx.sql_injection_anomaly_score=4"

# Common SQL keywords (used by SQLi detection rules)
SecAction "id:900102,phase:1,nolog,pass,setvar:tx.sql_keywords=union|select|insert|update|delete|drop|create|alter|exec|execute|script|javascript|onerror|onload"

###############################################################################
# Cross-Site Scripting (XSS) Protection
###############################################################################

# Enable XSS detection
SecAction "id:900110,phase:1,nolog,pass,setvar:tx.xss_enabled=1"

# XSS anomaly score threshold
SecAction "id:900111,phase:1,nolog,pass,setvar:tx.xss_anomaly_score=5"

# XSS patterns (script tags, event handlers, etc.)
SecAction "id:900112,phase:1,nolog,pass,setvar:tx.xss_patterns=<script|onerror|onload|onclick|<iframe|<object|<embed|javascript:"

###############################################################################
# Local File Inclusion (LFI) Protection
###############################################################################

# Enable LFI detection
SecAction "id:900120,phase:1,nolog,pass,setvar:tx.lfi_enabled=1"

# LFI anomaly score
SecAction "id:900121,phase:1,nolog,pass,setvar:tx.lfi_anomaly_score=3"

# Path traversal patterns
SecAction "id:900122,phase:1,nolog,pass,setvar:tx.lfi_patterns=\.\./|\.\.\\|%2e%2e|\.\.%2f"

###############################################################################
# Remote File Inclusion (RFI) Protection
###############################################################################

# Enable RFI detection
SecAction "id:900130,phase:1,nolog,pass,setvar:tx.rfi_enabled=1"

# RFI anomaly score
SecAction "id:900131,phase:1,nolog,pass,setvar:tx.rfi_anomaly_score=8"

# RFI patterns (http://, https://, ftp://, etc.)
SecAction "id:900132,phase:1,nolog,pass,setvar:tx.rfi_patterns=http://|https://|ftp://|php://|file://|gopher://"

###############################################################################
# Remote Code Execution (RCE) Protection
###############################################################################

# Enable RCE detection
SecAction "id:900140,phase:1,nolog,pass,setvar:tx.rce_enabled=1"

# RCE anomaly score
SecAction "id:900141,phase:1,nolog,pass,setvar:tx.rce_anomaly_score=8"

# Command execution patterns
SecAction "id:900142,phase:1,nolog,pass,setvar:tx.rce_patterns=exec|shell_exec|system|passthru|eval|assert|preg_replace|create_function"

###############################################################################
# Protocol Attack Protection
###############################################################################

# Enable protocol enforcement
SecAction "id:900200,phase:1,nolog,pass,setvar:tx.protocol_enforcement_enabled=1"

# HTTP Request Smuggling detection
SecAction "id:900201,phase:1,nolog,pass,setvar:tx.http_smuggling_enabled=1"

# HTTP Response Splitting detection
SecAction "id:900202,phase:1,nolog,pass,setvar:tx.response_splitting_enabled=1"

# Invalid header patterns
SecAction "id:900203,phase:1,nolog,pass,setvar:tx.header_injection_patterns=%0d|%0a|%09|\\r|\\n|\\t"

###############################################################################
# Session Security
###############################################################################

# Enable session fixation detection
SecAction "id:900210,phase:1,nolog,pass,setvar:tx.session_fixation_enabled=1"

# Session fixation threshold
SecAction "id:900211,phase:1,nolog,pass,setvar:tx.session_fixation_score=4"

# Track session IDs per user
SecAction "id:900212,phase:1,nolog,pass,setvar:session.id=%{HTTP_COOKIE}"

###############################################################################
# Bot Detection
###############################################################################

# Enable bot detection
SecAction "id:900220,phase:1,nolog,pass,setvar:tx.bot_detection_enabled=1"

# Known bad bots (User-Agent patterns)
SecAction "id:900221,phase:1,nolog,pass,setvar:tx.bad_bots=sqlmap|nikto|nmap|metasploit|nessus|qualys|acunetix|burpsuite|zaproxy"

# Detect SQLmap
SecRule HTTP_USER_AGENT "@rx sqlmap" "id:900230,phase:1,log,block,msg:'SQL injection tool detected',tag:'Bot Detection'"

# Detect Nikto
SecRule HTTP_USER_AGENT "@rx nikto" "id:900231,phase:1,log,block,msg:'Web scanner detected',tag:'Bot Detection'"

###############################################################################
# Logging and Alerting
###############################################################################

# Enable detailed rule logging
SecAction "id:900300,phase:1,nolog,pass,setvar:tx.detailed_logging=1"

# Enable audit logging for all blocks
SecAction "id:900301,phase:1,nolog,pass,setvar:tx.audit_all_blocks=1"

# Logging level (debug=9, notice=5, warn=4)
SecAction "id:900302,phase:1,nolog,pass,setvar:tx.logging_level=5"

# Send alerts to Alertmanager for blocks
SecAction "id:900303,phase:1,nolog,pass,setvar:tx.alertmanager_enabled=1"

###############################################################################
# Allowed File Upload Extensions
###############################################################################

SecAction "id:900400,phase:1,nolog,pass,setvar:tx.allowed_upload_extensions=.jpg|.jpeg|.png|.gif|.pdf|.doc|.docx|.xlsx|.pptx|.csv"

# Block dangerous upload extensions
SecAction "id:900401,phase:1,nolog,pass,setvar:tx.blocked_upload_extensions=.exe|.bat|.cmd|.com|.sh|.bash|.php|.php3|.php4|.php5|.phtml|.jsp|.jspx|.asp|.aspx|.cgi|.pl"

# Validate uploaded files against extension
SecRule FILES_TMPNAMES "@rx \.exe$|\.bat$|\.cmd$|\.php$|\.jsp$|\.asp$" "id:900402,phase:2,log,block,msg:'Dangerous file type uploaded',tag:'File Upload Enforcement',tag:'Malicious File Upload'"

###############################################################################
# Geolocation-based Rules (Optional)
###############################################################################

# Track request geolocation
SecAction "id:900500,phase:1,nolog,pass,setvar:tx.geoip_tracking=1"

# Can be used to block requests from certain countries (if needed)
# SecRule GEO_COUNTRY "!@within US|CA|UK|AU" "id:900501,phase:1,log,nolog,pass"

###############################################################################
# Anomaly Scoring Thresholds
###############################################################################

# Inbound anomaly score threshold (block if exceeded)
SecAction "id:900600,phase:1,nolog,pass,setvar:tx.inbound_anomaly_score_threshold=5"

# Outbound anomaly score threshold (alert if exceeded)
SecAction "id:900601,phase:1,nolog,pass,setvar:tx.outbound_anomaly_score_threshold=4"

# Outbound anomaly score detection
SecAction "id:900602,phase:1,nolog,pass,setvar:tx.outbound_anomaly_score=0"

###############################################################################
# Custom Application Rules
###############################################################################

# Include any custom organization-specific rules
Include /etc/modsecurity/modsecurity-custom-rules.conf

###############################################################################
# End of CRS Setup Configuration
###############################################################################
