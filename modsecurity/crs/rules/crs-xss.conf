# OWASP Core Rule Set v4.0 - Cross-Site Scripting (XSS) Rules
# Rules for detecting XSS attacks
# Rule Range: 2001-2100

###############################################################################
# XSS Detection Rules (CRS-2001-2050)
###############################################################################

# XSS - Script tag detection
SecRule ARGS|HEADERS "@rx <\s*script[^>]*>|</\s*script\s*>" \
    "id:2001,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - Script Tag',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    tag:'crs-v4.0.0-http-attack',\
    severity:CRITICAL,\
    capture,\
    setvar:tx.xss_score=+4,\
    setvar:ip.xss_attempts=+1"

# XSS - Event handler injection (onerror, onclick, etc.)
SecRule ARGS|HEADERS "@rx \b(onerror|onclick|onload|onmouseover|onmouseenter|onkeyup|onchange|oncopy|onpaste)\s*=" \
    "id:2002,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - Event Handler',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+5,\
    setvar:ip.xss_attempts=+1"

# XSS - Iframe injection
SecRule ARGS|HEADERS "@rx <\s*iframe[^>]*>|</\s*iframe\s*>" \
    "id:2003,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - Iframe Injection',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+4"

# XSS - Object/Embed tag injection
SecRule ARGS|HEADERS "@rx <\s*(object|embed)[^>]*>|</\s*(object|embed)\s*>" \
    "id:2004,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - Object/Embed Tag',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+4"

# XSS - Applet tag injection
SecRule ARGS|HEADERS "@rx <\s*applet[^>]*>|</\s*applet\s*>" \
    "id:2005,\
    phase:2,\
    log,block,\
    msg:'XSS Attack Detected - Applet Tag',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.xss_score=+3"

# XSS - Image tag with handler
SecRule ARGS|HEADERS "@rx <\s*img[^>]*\b(onerror|onclick)\s*=" \
    "id:2006,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - Image Tag Handler',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+4"

# XSS - SVG tag injection
SecRule ARGS|HEADERS "@rx <\s*svg[^>]*>|<\s*use[^>]*>" \
    "id:2007,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - SVG Tag Injection',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.xss_score=+3"

# XSS - JavaScript protocol handler
SecRule ARGS|HEADERS "@rx javascript\s*:" \
    "id:2008,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - JavaScript Protocol',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+4"

# XSS - Data URL with script
SecRule ARGS|HEADERS "@rx data\s*:\s*text/(html|javascript)|data\s*:\s*application/(javascript|x-javascript)" \
    "id:2009,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - Data URL Script',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+4"

# XSS - Vbscript protocol handler
SecRule ARGS|HEADERS "@rx vbscript\s*:" \
    "id:2010,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Detected - VBScript Protocol',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+4"

###############################################################################
# XSS - Encoded and Obfuscated Patterns
###############################################################################

# XSS - HTML entity encoding bypass
SecRule ARGS|HEADERS "@rx &#x?[0-9a-fA-F]{2,};" \
    "id:2011,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - HTML Entity Encoding Bypass',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.xss_score=+1"

# XSS - URL encoding bypass
SecRule ARGS|HEADERS "@rx %3Cscript|%3c.*%3e|%27.*%22" \
    "id:2012,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - URL Encoded Payload',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.xss_score=+1"

# XSS - Double encoding bypass
SecRule ARGS|HEADERS "@rx %25.*%25|%%25%%25" \
    "id:2013,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - Double Encoding Bypass',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.xss_score=+1"

###############################################################################
# XSS - Advanced Patterns
###############################################################################

# XSS - Style tag injection
SecRule ARGS|HEADERS "@rx <\s*style[^>]*>|</\s*style\s*>" \
    "id:2014,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - Style Tag Injection',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:MEDIUM,\
    setvar:tx.xss_score=+2"

# XSS - Link tag with event handler
SecRule ARGS|HEADERS "@rx <\s*link[^>]*\b(onerror)\s*=" \
    "id:2015,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - Link Tag Handler',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.xss_score=+3"

# XSS - Meta tag injection
SecRule ARGS|HEADERS "@rx <\s*meta[^>]*http-equiv\s*=\s*['\"]?refresh" \
    "id:2016,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - Meta Tag Refresh',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.xss_score=+2"

# XSS - Form tag with action to external URL
SecRule ARGS|HEADERS "@rx <\s*form[^>]*action\s*=\s*['\"]?https?://" \
    "id:2017,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - Form Tag Exploitation',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.xss_score=+3"

# XSS - Base tag injection
SecRule ARGS|HEADERS "@rx <\s*base[^>]*href\s*=" \
    "id:2018,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - Base Tag Injection',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.xss_score=+2"

# XSS - Eval() function call
SecRule ARGS|HEADERS "@rx \beval\s*\(" \
    "id:2019,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack - Eval Function',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:CRITICAL,\
    setvar:tx.xss_score=+4"

# XSS - SetTimeout/SetInterval with code
SecRule ARGS|HEADERS "@rx \b(setTimeout|setInterval)\s*\(\s*['\"]" \
    "id:2020,\
    phase:2,\
    log,block,\
    msg:'XSS Attack - SetTimeout/SetInterval',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    severity:HIGH,\
    setvar:tx.xss_score=+3"

###############################################################################
# XSS - Anomaly Scoring
###############################################################################

# Trigger blocking if XSS score exceeds threshold
SecRule TX.xss_score "@ge %{tx.xss_anomaly_score}" \
    "id:2050,\
    phase:2,\
    log,auditlog,block,\
    msg:'XSS Attack Blocked - Cumulative Score Exceeded',\
    tag:'attack/xss',\
    tag:'OWASP_CRS',\
    tag:'anomaly-evaluation',\
    severity:CRITICAL"

# Reset XSS score for next request
SecAction "id:2099,\
    phase:5,\
    nolog,pass,\
    setvar:tx.xss_score=0"

###############################################################################
# End of XSS Rules
###############################################################################
