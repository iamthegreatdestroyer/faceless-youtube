# ModSecurity Custom Application Rules
# Application-specific WAF rules for FacelessYouTube
# Customizations and business logic protection

###############################################################################
# Session Management
###############################################################################

# Require CSRF token for state-changing operations
SecRule REQUEST_METHOD "@pm POST PUT DELETE" \
    "id:4001,\
    phase:2,\
    log,nolog,pass,\
    msg:'CSRF Token Validation Required'"

# Check for valid CSRF token in POST requests
SecRule REQUEST_METHOD "@streq POST" \
    "id:4002,\
    phase:2,\
    log,block,\
    msg:'Missing CSRF Token',\
    tag:'session-security',\
    tag:'OWASP_Top_10',\
    severity:HIGH,\
    chain"
    SecRule "&ARGS:csrf_token" "@eq 0" "setvar:tx.csrf_check_failed=1"

###############################################################################
# Authentication Protection
###############################################################################

# Enforce strong password requirements on signup/password change
SecRule REQUEST_URI "@rx /api/v\d+/(auth/register|auth/change-password)" \
    "id:4010,\
    phase:2,\
    log,nolog,pass,\
    msg:'Password Policy Check'"

# Detect brute force attempts on login endpoint
SecRule REQUEST_URI "@rx /api/v\d+/auth/login" \
    "id:4011,\
    phase:2,\
    log,block,\
    msg:'Brute Force Attack Detection',\
    tag:'authentication',\
    tag:'brute-force',\
    severity:HIGH,\
    setvar:ip.login_attempts=+1,\
    chain"
    SecRule ip.login_attempts "@gt 10" "setvar:ip.blocked=1"

# Block IP after multiple failed login attempts
SecRule ip.blocked "@eq 1" \
    "id:4012,\
    phase:1,\
    log,auditlog,block,\
    msg:'IP Blocked - Excessive Login Attempts',\
    tag:'authentication',\
    tag:'brute-force',\
    severity:CRITICAL"

###############################################################################
# API Rate Limiting
###############################################################################

# Apply rate limiting per endpoint
SecRule REQUEST_URI "@rx /api/v\d+/videos/search" \
    "id:4020,\
    phase:2,\
    nolog,pass,\
    setvar:ip.search_requests=+1,\
    setvar!ip.search_window_start:%{TIME_EPOCH}"

# Block excessive search API calls (>100 per minute)
SecRule ip.search_requests "@gt 100" \
    "id:4021,\
    phase:2,\
    log,block,\
    msg:'Search API Rate Limit Exceeded',\
    tag:'rate-limiting',\
    tag:'api-abuse',\
    severity:HIGH"

# Apply rate limiting to upload endpoint
SecRule REQUEST_URI "@rx /api/v\d+/uploads" \
    "id:4030,\
    phase:2,\
    nolog,pass,\
    setvar:ip.upload_requests=+1"

# Block excessive upload attempts (>10 per hour)
SecRule ip.upload_requests "@gt 10" \
    "id:4031,\
    phase:2,\
    log,block,\
    msg:'Upload API Rate Limit Exceeded',\
    tag:'rate-limiting',\
    tag:'upload-abuse',\
    severity:HIGH"

###############################################################################
# File Upload Protection
###############################################################################

# Validate file uploads to /api/uploads endpoint
SecRule REQUEST_URI "@rx /api/v\d+/uploads" \
    "id:4040,\
    phase:2,\
    nolog,pass,\
    msg:'File Upload Validation'"

# Only allow specific file types for uploads
SecRule FILES_NAMES "@rx \.exe$|\.bat$|\.cmd$|\.com$|\.sh$|\.php$|\.jsp$|\.asp$" \
    "id:4041,\
    phase:2,\
    log,auditlog,block,\
    msg:'Dangerous File Type Upload Blocked',\
    tag:'file-upload',\
    tag:'malicious-files',\
    severity:CRITICAL,\
    capture"

# Limit upload file size (100MB max)
SecRule CONTENT_LENGTH "@gt 104857600" \
    "id:4042,\
    phase:1,\
    log,block,\
    msg:'Upload File Size Exceeds Limit',\
    tag:'file-upload',\
    tag:'abuse',\
    severity:HIGH"

# Validate file MIME type matches extension
SecRule FILES_MIME_TYPE "@rx ^application/x-executable|^application/x-msdownload|^application/x-msdos-program" \
    "id:4043,\
    phase:2,\
    log,auditlog,block,\
    msg:'Executable File Upload Blocked',\
    tag:'file-upload',\
    tag:'malicious-files',\
    severity:CRITICAL"

###############################################################################
# API Endpoint Protection
###############################################################################

# Validate JSON content type for API endpoints
SecRule REQUEST_URI "@rx /api/v\d+" \
    "id:4050,\
    phase:1,\
    nolog,pass,\
    msg:'API Endpoint Access'"

# Block non-JSON content for API POST requests
SecRule REQUEST_METHOD "@streq POST" \
    "id:4051,\
    phase:1,\
    log,block,\
    msg:'Invalid Content-Type for API Request',\
    tag:'api-validation',\
    tag:'protocol-enforcement',\
    severity:HIGH,\
    chain"
    SecRule CONTENT_TYPE "!@rx ^application/json|^application/x-www-form-urlencoded" "setvar:tx.invalid_content_type=1"

# Enforce API versioning
SecRule REQUEST_URI "@rx /api/v0" \
    "id:4060,\
    phase:1,\
    log,block,\
    msg:'Deprecated API Version Detected',\
    tag:'api-versioning',\
    tag:'policy-enforcement',\
    severity:MEDIUM"

###############################################################################
# Data Validation
###############################################################################

# Validate email format in user registration
SecRule ARGS:email "@rx [^@]+@[^\.]+\.[^\.]{2,}" \
    "id:4070,\
    phase:2,\
    nolog,pass,\
    msg:'Email Format Validation'"

# Block invalid email formats
SecRule REQUEST_URI "@rx /api/v\d+/auth/register" \
    "id:4071,\
    phase:2,\
    log,block,\
    msg:'Invalid Email Format',\
    tag:'data-validation',\
    tag:'input-validation',\
    severity:MEDIUM,\
    chain"
    SecRule ARGS:email "!@rx ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"

# Validate username format
SecRule REQUEST_URI "@rx /api/v\d+/auth/register" \
    "id:4072,\
    phase:2,\
    log,nolog,pass,\
    msg:'Username Validation'"

# Username must be 3-50 characters, alphanumeric + underscore
SecRule ARGS:username "!@rx ^[a-zA-Z0-9_]{3,50}$" \
    "id:4073,\
    phase:2,\
    log,block,\
    msg:'Invalid Username Format',\
    tag:'data-validation',\
    tag:'input-validation',\
    severity:MEDIUM"

###############################################################################
# Response Protection
###############################################################################

# Ensure sensitive headers are not leaked in responses
SecRule RESPONSE_HEADERS:X-Powered-By "@rx Apache|IIS|PHP" \
    "id:4100,\
    phase:3,\
    log,nolog,pass,\
    msg:'Server Software Detected in Response Header',\
    tag:'information-disclosure',\
    tag:'header-enforcement',\
    severity:LOW"

# Prevent information disclosure in error messages
SecRule RESPONSE_BODY "@rx (error|exception|fatal|undefined|syntax error)" \
    "id:4101,\
    phase:4,\
    log,pass,\
    msg:'Error Information in Response Body',\
    tag:'information-disclosure',\
    tag:'error-handling',\
    severity:LOW"

# Ensure Cache-Control headers prevent sensitive data caching
SecRule RESPONSE_HEADERS:Cache-Control "!@rx no-cache|no-store|private" \
    "id:4102,\
    phase:3,\
    log,nolog,pass,\
    msg:'Missing Cache-Control Header for API Response',\
    tag:'response-security',\
    tag:'caching-policy',\
    severity:MEDIUM"

###############################################################################
# Logging and Alerting
###############################################################################

# Log all authentication attempts
SecAction "id:4200,\
    phase:2,\
    log,pass,\
    msg:'Authentication Attempt Logged'"

# Alert on suspicious patterns
SecRule TX.anomaly_score "@ge 5" \
    "id:4201,\
    phase:2,\
    log,auditlog,pass,\
    msg:'Suspicious Request Pattern Detected - Alert Triggered',\
    tag:'anomaly-detection',\
    tag:'security-alert',\
    severity:HIGH"

# Log potential account enumeration attempts
SecRule REQUEST_URI "@rx /api/v\d+/users/[0-9]+" \
    "id:4210,\
    phase:2,\
    log,nolog,pass,\
    msg:'User Account Lookup Detected',\
    tag:'account-enumeration',\
    tag:'recon'"

###############################################################################
# Exception Handling
###############################################################################

# Whitelist internal API calls from localhost
SecRule REMOTE_ADDR "@streq 127.0.0.1|::1" \
    "id:4300,\
    phase:1,\
    nolog,pass,\
    ctl:RuleEngine=Off"

# Exempt health check endpoint from all rules
SecRule REQUEST_URI "@streq /health" \
    "id:4301,\
    phase:1,\
    nolog,pass,\
    ctl:RuleEngine=Off"

# Exempt Prometheus metrics from rules
SecRule REQUEST_URI "@streq /metrics" \
    "id:4302,\
    phase:1,\
    nolog,pass,\
    ctl:RuleEngine=Off"

###############################################################################
# End of Custom Application Rules
###############################################################################
